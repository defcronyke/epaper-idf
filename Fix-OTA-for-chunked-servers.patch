From 82793db4586b73c980711e425a10e24551663315 Mon Sep 17 00:00:00 2001
From: Shubham Kulkarni <shubham.kulkarni@espressif.com>
Date: Fri, 24 Jan 2020 10:55:16 +0530
Subject: [PATCH] esp_https_ota: Fix OTA for chunked servers

---
 components/esp_https_ota/src/esp_https_ota.c | 16 ++++++++--------
 1 file changed, 8 insertions(+), 8 deletions(-)

diff --git a/components/esp_https_ota/src/esp_https_ota.c b/components/esp_https_ota/src/esp_https_ota.c
index 0cda4439d4..6c2759b479 100644
--- a/components/esp_https_ota/src/esp_https_ota.c
+++ b/components/esp_https_ota/src/esp_https_ota.c
@@ -296,18 +296,18 @@ esp_err_t esp_https_ota_perform(esp_https_ota_handle_t https_ota_handle)
                                              handle->ota_upgrade_buf,
                                              handle->ota_upgrade_buf_size);
             if (data_read == 0) {
-                /*
-                 * As esp_http_client_read never returns negative error code, we rely on
-                 * `errno` to check for underlying transport connectivity closure if any
-                 */
-                if (errno == ENOTCONN || errno == ECONNRESET) {
-                    ESP_LOGE(TAG, "Connection closed, errno = %d", errno);
-                    return ESP_FAIL;
-                }
                 /*  esp_https_ota_is_complete_data_received is added to check whether
                     complete image is received.
                 */
                 if (!esp_https_ota_is_complete_data_received(https_ota_handle)) {
+                    /*
+                    * As esp_http_client_read never returns negative error code, we rely on
+                    * `errno` to check for underlying transport connectivity closure if any
+                    */
+                    if (errno == ENOTCONN || errno == ECONNRESET) {
+                        ESP_LOGE(TAG, "Connection closed, errno = %d", errno);
+                        return ESP_FAIL;
+                    }
                     return ESP_ERR_HTTPS_OTA_IN_PROGRESS;
                 }
                 ESP_LOGI(TAG, "Connection closed");
-- 
2.21.0 (Apple Git-122.2)

